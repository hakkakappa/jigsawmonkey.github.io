<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HTML5 Jigsaw Puzzle</title>
<style>
  body {
    margin: 0;
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  canvas {
    background: #222;
    border: 2px solid #fff;
  }
</style>
</head>
<body>
<canvas id="puzzle"></canvas>

<script>
const canvas = document.getElementById('puzzle');
const ctx = canvas.getContext('2d');

const img = new Image();
img.src = 'https://i.imgur.com/4AiXzf8.jpg'; // sample image
const rows = 3;
const cols = 3;
let pieces = [];
let pieceWidth, pieceHeight;
let draggedPiece = null;
let offsetX, offsetY;

function createPiecePath(x, y, width, height, topTab, rightTab, bottomTab, leftTab) {
  const tabSize = Math.min(width, height) / 4;
  ctx.beginPath();
  ctx.moveTo(x, y);

  // Top edge
  if (topTab !== 0) {
    const dir = topTab;
    ctx.lineTo(x + width / 3, y);
    ctx.bezierCurveTo(
      x + width / 3, y - dir * tabSize,
      x + 2 * width / 3, y - dir * tabSize,
      x + 2 * width / 3, y
    );
  }
  ctx.lineTo(x + width, y);

  // Right edge
  if (rightTab !== 0) {
    const dir = rightTab;
    ctx.lineTo(x + width, y + height / 3);
    ctx.bezierCurveTo(
      x + width + dir * tabSize, y + height / 3,
      x + width + dir * tabSize, y + 2 * height / 3,
      x + width, y + 2 * height / 3
    );
  }
  ctx.lineTo(x + width, y + height);

  // Bottom edge
  if (bottomTab !== 0) {
    const dir = bottomTab;
    ctx.lineTo(x + 2 * width / 3, y + height);
    ctx.bezierCurveTo(
      x + 2 * width / 3, y + height + dir * tabSize,
      x + width / 3, y + height + dir * tabSize,
      x + width / 3, y + height
    );
  }
  ctx.lineTo(x, y + height);

  // Left edge
  if (leftTab !== 0) {
    const dir = leftTab;
    ctx.lineTo(x, y + 2 * height / 3);
    ctx.bezierCurveTo(
      x - dir * tabSize, y + 2 * height / 3,
      x - dir * tabSize, y + height / 3,
      x, y + height / 3
    );
  }

  ctx.closePath();
}

img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;

  pieceWidth = canvas.width / cols;
  pieceHeight = canvas.height / rows;

  // Create pieces with random tabs (1 = out, -1 = in, 0 = edge)
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      pieces.push({
        x: Math.random() * (canvas.width - pieceWidth),
        y: Math.random() * (canvas.height - pieceHeight),
        originalX: x * pieceWidth,
        originalY: y * pieceHeight,
        row: y,
        col: x,
        topTab: y === 0 ? 0 : -pieces[(y-1)*cols + x].bottomTab,
        rightTab: x === cols -1 ? 0 : Math.random() > 0.5 ? 1 : -1,
        bottomTab: y === rows -1 ? 0 : Math.random() > 0.5 ? 1 : -1,
        leftTab: x === 0 ? 0 : 0 // will be set when next piece is created
      });
    }
  }

  drawPieces();
};

function drawPieces() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const p of pieces) {
    ctx.save();
    ctx.beginPath();
    createPiecePath(0, 0, pieceWidth, pieceHeight, p.topTab, p.rightTab, p.bottomTab, p.leftTab);
    ctx.clip();
    ctx.drawImage(
      img,
      p.col * pieceWidth,
      p.row * pieceHeight,
      pieceWidth,
      pieceHeight,
      p.x,
      p.y,
      pieceWidth,
      pieceHeight
    );
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke(createPiecePath(0,0,pieceWidth,pieceHeight,p.topTab,p.rightTab,p.bottomTab,p.leftTab));
    ctx.restore();
  }
}

canvas.addEventListener('mousedown', e => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  for (let i = pieces.length - 1; i >= 0; i--) {
    const p = pieces[i];
    if (
      mouseX > p.x &&
      mouseX < p.x + pieceWidth &&
      mouseY > p.y &&
      mouseY < p.y + pieceHeight
    ) {
      draggedPiece = p;
      offsetX = mouseX - p.x;
      offsetY = mouseY - p.y;
      pieces.push(pieces.splice(i, 1)[0]); // bring to top
      break;
    }
  }
});

canvas.addEventListener('mousemove', e => {
  if (!draggedPiece) return;
  const rect = canvas.getBoundingClientRect();
  draggedPiece.x = e.clientX - rect.left - offsetX;
  draggedPiece.y = e.clientY - rect.top - offsetY;
  drawPieces();
});

canvas.addEventListener('mouseup', e => {
  if (!draggedPiece) return;

  if (
    Math.abs(draggedPiece.x - draggedPiece.originalX) < pieceWidth / 3 &&
    Math.abs(draggedPiece.y - draggedPiece.originalY) < pieceHeight / 3
  ) {
    draggedPiece.x = draggedPiece.originalX;
    draggedPiece.y = draggedPiece.originalY;
  }

  draggedPiece = null;
  drawPieces();
});
</script>
</body>
</html>
